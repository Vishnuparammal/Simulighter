<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0" />
	<title>Light Simulator</title>

	<script src="p5.js"></script>

	<style type="text/css">
		html, body {
			padding: 0px;
			margin: 0px;
		}
		ul.toolbar li{
			float: left;
			padding-left: 1em;
			padding-bottom: 5px;
		}

		div.edit-toolbar {
			float: right;
			margin: 0.5em;
		}

		ul.toolbar li button {
			background-color: #262626;
			border-width: 0px;
			color: white;
			padding: 0.8em 1.2em 0.8em 1.2em;
		}
		ul.toolbar li button:hover {
			background-color: #000000;
		}
	</style>
</head>
<body>

	<div style="padding: 0;">
		<ul style="list-style-type: none;" class="toolbar">
			<li><button id="ray-btn">Ray</button></li>
			<li><button id="lens-btn">Lens</button></li>
			<li><button id="mirror-btn">Mirror</button></li>
		</ul>
	</div>
	<div class="edit-toolbar">
		<button id="undo">Undo</button>
		<button id="redo">Redo</button>
	</div>
	<div id="sketch-holder">
		<!-- Our sketch will go here! -->
	</div>
	<script type="text/javascript">

		let Point = function(x,y){
			this.x = x;
			this.y = y;

			if(typeof this.draw !== 'function'){
				Point.prototype.draw = function(){
					push();
					fill(255,0,0);
					stroke(255,0,0);
					strokeWeight(4);
					point(this.x, this.y);
					pop();
				};
			}

		}

		let Line  = function(p1, p2){
			this.start = p1;
			this.next  = p2;

			if(typeof this.extend !== 'function'){
				Line.prototype.extend = function(x,y){
					this.next = new Point(x,y);
					if(this.next.y==this.start.y)
						extend=1;
					else
						extend=2;
					
					switch(extend){
						case 1:
							if(this.next.x>this.start.x)
								extend=windowWidth;
							else if(this.next.x<this.start.x)
								extend=0;
							this.next.x=extend;
							break;
						case 2:
							if(this.next.y>this.start.y)
								extend=windowHeight;
							else if (this.next.y<this.start.y)
								extend=0;
							this.next.x=(extend-this.start.y)/(this.next.y-this.start.y)*(this.next.x-this.start.x)+this.start.x;
							this.next.y=extend;
							break;
					}
				}
			}
			
			if(typeof this.draw !== 'function'){
				Line.prototype.draw = function(){
					line(this.start.x, this.start.y, this.next.x, this.next.y);
				};
			}
			
		};
    
    let Mirror = function(p1,p2,p3,roc){
			this.roc = roc;
			this.pole=p1;
			this.start=p2;
			this.end = p3;
			this.tempangle=0;
			this.center=new Point(this.pole.x-roc,this.pole.y);
			
			this.angle=atan(-(this.start.y-this.center.y)/(this.start.x-this.center.x));
      
			if(typeof this.setStart !=='function'){
      		Mirror.prototype.setStart = function(x, y){
        	this.start = new Point(x,y);
		this.angle=atan(-(this.start.y-this.center.y)/(this.start.x-this.center.x));
		if (this.angle<0)
		{
			this.angle+=PI;
		}
        }
      }
      
      if(typeof this.setEnd !=='function'){
      	Mirror.prototype.setEnd = function(x, y){
			this.end = new Point(x,y);
			this.tempangle = atan2((this.end.y-this.pole.y),(this.end.x-this.pole.x));
			this.center.x=this.roc*cos(this.tempangle) +this.pole.x;			
			this.center.y=(this.roc*sin(this.tempangle) + this.pole.y);
			this.tempangle += PI;
        }
      }
			
			if(typeof this.draw !=='function'){
				Mirror.prototype.draw = function(){
					push();
          			noFill();
          			arc(this.center.x,this.center.y,this.roc*2,this.roc*2,-this.angle+this.tempangle,this.angle+this.tempangle);
          			pop();
          			this.pole.draw();
          			this.center.draw();

				};
			}
			
		};

		let Lens = function(p1,p2,p3,roc){
			this.roc = roc;
			this.pole=p1;
			this.start=p2;
			this.end = p3;
			this.angle=PI/2;
			this.tempangle=0;
			this.center1=new Point(this.pole.x-roc*cos(this.angle),this.pole.y);
			this.center2=new Point(this.pole.x+roc*cos(this.angle),this.pole.y);
			      
			if(typeof this.setStart !=='function'){
      		Lens.prototype.setStart = function(x, y){
        	this.start = new Point(x,y);
        	if (abs(this.pole.y-this.start.y)<=this.roc && abs(this.pole.y-this.start.y)>0)
        		this.angle=asin(abs(this.pole.y-this.start.y)/this.roc);
        	else	
        		this.angle=PI/2;
        	
		this.center1=new Point(this.pole.x-this.roc*cos(this.angle),this.pole.y);
		this.center2=new Point(this.pole.x+this.roc*cos(this.angle),this.pole.y);
		
        }
      }
      
      if(typeof this.setEnd !=='function'){
      	Lens.prototype.setEnd = function(x, y){
			this.end = new Point(x,y);
			this.tempangle = atan2((this.end.y-this.pole.y),(this.end.x-this.pole.x));
			
			this.center1.x=this.roc*cos(this.angle)*cos(this.tempangle) + this.pole.x;			
			this.center1.y=this.roc*cos(this.angle)*sin(this.tempangle) + this.pole.y;
			this.center2.x=this.roc*cos(this.angle)*cos(this.tempangle+PI) + this.pole.x;			
			this.center2.y=this.roc*cos(this.angle)*sin(this.tempangle+PI) + this.pole.y;
			this.tempangle += PI;
        }
      }
			
			if(typeof this.draw !=='function'){
				Lens.prototype.draw = function(){
					push();
          			arc(this.center1.x,this.center1.y,this.roc*2,this.roc*2,-this.angle+this.tempangle,this.angle+this.tempangle,OPEN);
				arc(this.center2.x,this.center2.y,this.roc*2,this.roc*2,-this.angle+this.tempangle + PI,this.angle+this.tempangle + PI,OPEN);
          			pop();
          			this.pole.draw();
          			this.center1.draw();
				this.center2.draw();

				};
			}
			
		};

		let bodyList     = [];
		let state        = {};
		let tempRedoList = [];

		document.querySelectorAll("ul.toolbar li button").forEach(function(button){
			button.onclick = function(){
				if(state.newBody !== undefined)
					if(state.step > 0)
						bodyList.pop();
				state = {newBody:button.id, step:0};
			}
		});

		document.getElementById("undo").onclick = function(){
			if(state.newBody !== undefined){
				//to-dos UNDO FOR PENDING BODIES
			}
			else{
				if(bodyList.length > 0)
					tempRedoList.push(bodyList.pop());
			}
		}

		document.getElementById("redo").onclick = function(){
			if(state.newBody !== undefined){
				//to-dos UNDO FOR PENDING BODIES
			}
			else{
				if(tempRedoList.length > 0)
					bodyList.push(tempRedoList.pop());
			}
		}

		function setup(){
			let canvas = createCanvas(windowWidth, windowHeight);
			canvas.parent('sketch-holder');
		}

		function mousePressed(){
			if(state.newBody === undefined)
				return;

			switch(state.newBody){
				case 'ray-btn':
					switch(state.step){
						case 0:
							bodyList.push(new Line(new Point(mouseX, mouseY), new Point(mouseX, mouseY)));
							state.step = 1;
							break;
						case 1:
							let newLine  = bodyList.pop();
							newLine.extend(mouseX,mouseY);
							bodyList.push(newLine);
							state = {};
							break;
					}
				break;
				case 'mirror-btn':
					switch(state.step){
						case 0:
							roc = 2*prompt('enter focal length');
							bodyList.push(new Mirror(new Point(mouseX,mouseY),new Point(mouseX,mouseY),new Point(mouseX,mouseY),roc));
							state.step = 1;
							break;
						case 1:
							let newMirror = bodyList.pop();
							newMirror.start = new Point(mouseX,mouseY);
							bodyList.push(newMirror);
							state.step = 2;
							break;
		   				case 2:
						   	let new2Mirror = bodyList.pop();
							new2Mirror.end = new Point(mouseX,mouseY);
							bodyList.push(new2Mirror);
							state = {};
							break;
					}
				break;
				case 'lens-btn':
					switch(state.step){
						case 0:
							roc = 2*prompt('enter focal length');
							bodyList.push(new Lens(new Point(mouseX,mouseY),new Point(mouseX,mouseY),new Point(mouseX,mouseY),roc));
							state.step = 1;
							break;
						case 1:
							let newLens = bodyList.pop();
							newLens.start = new Point(mouseX,mouseY);
							bodyList.push(newLens);
							state.step = 2;
							break;
						case 2:
					   		let new2Lens = bodyList.pop();
							new2Lens.end = new Point(mouseX,mouseY);
							bodyList.push(new2Lens);
							state = {};
							break;
					}
      				break;
			}
		}

		function mouseMoved(){
			if(state.newBody === undefined)
				return;

			switch(state.newBody){
				case 'ray-btn':
					switch(state.step){
						case 1:
							let newLine  = bodyList.pop();
							newLine.extend(mouseX,mouseY);
							bodyList.push(newLine);
							break;
					}
				break;
				case 'mirror-btn':
					switch(state.step){
						case 1:
							let newMirror = bodyList.pop();
							newMirror.setStart(mouseX,mouseY);
							bodyList.push(newMirror);
							break;
						case 2:
					    		let new2Mirror = bodyList.pop();
							new2Mirror.setEnd(mouseX,mouseY);
							bodyList.push(new2Mirror);
							break;
					}
				break;
				case 'lens-btn':
					switch(state.step){
						case 1:
							let newLens = bodyList.pop();
							newLens.setStart(mouseX,mouseY);
							bodyList.push(newLens);
							break;
						case 2:
					    		let new2Lens = bodyList.pop();
							new2Lens.setEnd(mouseX,mouseY);
							bodyList.push(new2Lens);
							break;
					}
				break;
			}
		}
		function drawGrid(){
		      
			push();
			stroke(0);
			strokeWeight(1);			
			for(i=0;i<=windowWidth;i+=10)
			      	line(i,0,i,windowHeight);
			for(i=0;i<=windowHeight;i+=10)
				line(0,i,windowWidth,i);
			pop();
		}

		function draw(){
			background(38);
			stroke(255);
			strokeWeight(4);
			fill(100);
			new Point(0,0).draw();
			drawGrid();

			bodyList.forEach(function(body){
				body.draw();
			});
		}
		
	</script>
</body>
</html>
